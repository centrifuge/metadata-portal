name: CLI

on:
  pull_request:
    branches:
      - master
    paths:
      - "cli/**"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Install rust dependencies
        uses: ./.github/workflows/rust-install

      - name: ğŸ” Debug Clang + LLVM
        run: |
          echo "ğŸ”§ which clang:"
          which clang
          clang --version

          echo "ğŸ”§ LIBCLANG_PATH:"
          echo "$LIBCLANG_PATH"
          echo "ğŸ”§ LD_LIBRARY_PATH:"
          echo "$LD_LIBRARY_PATH"
          echo "ğŸ”§ PKG_CONFIG_PATH:"
          echo "$PKG_CONFIG_PATH"

          echo "ğŸ” libclang.so symlink:"
          ls -l $LIBCLANG_PATH/libclang.so || echo "âŒ libclang.so missing"

          echo "ğŸ” libclang-18.so.18 presence:"
          ls -l /usr/lib/x86_64-linux-gnu/libclang-18.so.18 || echo "âŒ libclang-18.so.18 missing"

          echo "ğŸ” llvm-config location and version:"
          which llvm-config || echo "âŒ llvm-config not found"
          llvm-config --version || echo "âŒ llvm-config broken"

          echo "ğŸ” llvm-config --libs:"
          llvm-config --libs || echo "âŒ cannot list LLVM libs"

          echo "ğŸ” llvm-config --cflags:"
          llvm-config --cflags || echo "âŒ cannot get LLVM cflags"

          echo "ğŸ” pkg-config opencv4:"
          pkg-config --modversion opencv4 || echo "âŒ pkg-config can't find opencv4"

          echo "âœ… Clang/LLVM debug check complete"

      - name: Cargo fmt
        run: cargo fmt --all -- --check

      - name: Cargo check
        run: cargo check

      - name: Cargo clippy
        run: cargo clippy -- -D warnings

      - name: Cargo test
        run: cargo test
