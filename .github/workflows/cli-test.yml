name: CLI

on:
  pull_request:
    branches:
      - master
    paths:
      - "cli/**"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: 🛎 Checkout
        uses: actions/checkout@v4

      - name: 🔧 Install system dependencies for Rust + OpenCV
        run: |
          sudo apt update
          sudo apt install -y \
            pkg-config \
            libopencv-dev \
            clang-18 \
            llvm-18 \
            llvm-18-dev \
            libclang-18-dev

      - name: Install OpenCV 4.6.0 from source
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake build-essential pkg-config \
            libgtk-3-dev libavcodec-dev libavformat-dev libswscale-dev \
            libv4l-dev libxvidcore-dev libx264-dev libjpeg-dev libpng-dev libtiff-dev \
            libopenexr-dev libatlas-base-dev gfortran python3-dev

          wget -q https://github.com/opencv/opencv/archive/4.6.0.tar.gz
          tar -xf 4.6.0.tar.gz
          cd opencv-4.6.0
          mkdir build && cd build

          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local ..
          make -j$(nproc) 2>&1 | tee build.log
          sudo make install

          echo "/usr/local/lib" | sudo tee /etc/ld.so.conf.d/opencv.conf
          sudo ldconfig

      - name: Set environment for pkg-config
        run: echo "PKG_CONFIG_PATH=/usr/local/lib/pkgconfig" >> $GITHUB_ENV

      - name: 🔍 Debug OpenCV installation
        run: |
          echo "OpenCV version via pkg-config:"
          pkg-config --modversion opencv4 || echo "Failed to find opencv4 via pkg-config"
          echo "OpenCV libraries:"
          pkg-config --libs opencv4 || echo "Failed to list opencv4 libs"
          echo "OpenCV headers:"
          ls -la /usr/include/opencv4 || echo "No opencv4 headers found"

      - name: 🔧 Install rust dependencies
        uses: ./.github/workflows/rust-install

      - name: Cargo fmt
        run: cargo fmt --all -- --check

      - name: Install OpenCV + Clang
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libopencv-dev \
            clang-18 llvm-18 llvm-18-dev libclang-18-dev \
            pkg-config

      - name: 🔍 Test OpenCV pkg-config
        run: |
          pkg-config --modversion opencv4 || pkg-config --modversion opencv

      - name: Cargo check
        run: cargo check
        env:
          LIBCLANG_PATH: /usr/lib/llvm-18/lib
          LD_LIBRARY_PATH: /usr/lib/llvm-18/lib
          LLVM_CONFIG_PATH: /usr/lib/llvm-18/bin/llvm-config
          OPENCV_CLANG_PATH: /usr/bin/clang-18
          PKG_CONFIG_PATH: /usr/lib/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig
          OPENCV4_NO_PKG_CONFIG: 0
          OPENCV4_STATIC: 0
          CXX: g++
          CC: gcc
          RUST_BACKTRACE: full
          RUSTFLAGS: "-C debuginfo=2"
          CARGO_PROFILE_DEV_BUILD_OVERRIDE_DEBUG: true

      - name: 🐛 Print OpenCV binding output (if exists)
        run: |
          echo ">>> Contents of target/debug/build/opencv-*/output <<<"
          cat $(find ./target/debug/build -name output | grep opencv | head -n1) || echo "No output log found"

      - name: Cargo clippy
        run: cargo clippy -- -D warnings
      - name: Cargo test
        run: cargo test
