runs:
  using: "composite"
  steps:
    - name: Install system dependencies
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pkg-config \
          libopencv-dev \
          clang-18 \
          llvm-18 \
          llvm-18-dev \
          libclang-18-dev \
          clang \
          g++ \
          cmake \
          libgtk-3-dev \
          libglib2.0-dev \
          libtbb-dev \
          libjpeg-dev \
          libpng-dev \
          libavcodec-dev \
          libavformat-dev \
          libswscale-dev

    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
        profile: minimal

    - name: 🔍 Debug Clang + LLVM
      run: |
        echo "🔧 which clang:"
        which clang
        clang --version

        echo "🔧 LIBCLANG_PATH:"
        echo "$LIBCLANG_PATH"
        echo "🔧 LD_LIBRARY_PATH:"
        echo "$LD_LIBRARY_PATH"
        echo "🔧 PKG_CONFIG_PATH:"
        echo "$PKG_CONFIG_PATH"

        echo "🔍 libclang.so symlink:"
        ls -l $LIBCLANG_PATH/libclang.so || echo "❌ libclang.so missing"

        echo "🔍 libclang-18.so.18 presence:"
        ls -l /usr/lib/x86_64-linux-gnu/libclang-18.so.18 || echo "❌ libclang-18.so.18 missing"

        echo "Checking llvm-config:"
        which llvm-config || echo "❌ llvm-config missing"
        llvm-config --version || echo "❌ llvm-config failed"

        echo "🔍 llvm-config --libs:"
        llvm-config --libs || echo "❌ cannot list LLVM libs"

        echo "🔍 llvm-config --cflags:"
        llvm-config --cflags || echo "❌ cannot get LLVM cflags"

        echo "🔍 pkg-config opencv4:"
        pkg-config --modversion opencv4 || echo "❌ pkg-config can't find opencv4"

        echo "✅ Clang/LLVM debug check complete"
      shell: bash

    - name: 🔍 Check llvm-config
      run: |
        echo "llvm-config: $(which llvm-config || echo MISSING)"
        llvm-config --version || echo "llvm-config call failed"
      shell: bash

    - name: 💾 Rust Cache
      uses: Swatinem/rust-cache@v2
