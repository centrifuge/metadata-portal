runs:
  using: "composite"
  steps:
    - name: ğŸ› ï¸ Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y clang-18 llvm-18 llvm-18-dev llvm-18-tools llvm-18-runtime libclang-18-dev libopencv-dev pkg-config

        # Make libclang discoverable
        sudo ln -sf /usr/lib/x86_64-linux-gnu/libclang-18.so.18 /usr/lib/llvm-18/lib/libclang.so

        # Expose variables to Rust build
        echo "LIBCLANG_PATH=/usr/lib/llvm-18/lib" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=/usr/lib/llvm-18/lib" >> $GITHUB_ENV
        echo "LLVM_CONFIG_PATH=/usr/lib/llvm-18/bin/llvm-config" >> $GITHUB_ENV
        echo "CLANG_PATH=/usr/bin/clang-18" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=/usr/lib/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig" >> $GITHUB_ENV
      shell: bash

    - name: ğŸ” Debug Clang + LLVM
      run: |
        echo "ğŸ”§ which clang:"
        which clang
        clang --version

        echo "ğŸ”§ LIBCLANG_PATH:"
        echo "$LIBCLANG_PATH"
        echo "ğŸ”§ LD_LIBRARY_PATH:"
        echo "$LD_LIBRARY_PATH"
        echo "ğŸ”§ PKG_CONFIG_PATH:"
        echo "$PKG_CONFIG_PATH"

        echo "ğŸ” libclang.so symlink:"
        ls -l $LIBCLANG_PATH/libclang.so || echo "âŒ libclang.so missing"

        echo "ğŸ” libclang-18.so.18 presence:"
        ls -l /usr/lib/x86_64-linux-gnu/libclang-18.so.18 || echo "âŒ libclang-18.so.18 missing"

        echo "Checking llvm-config:"
        which llvm-config || echo "âŒ llvm-config missing"
        llvm-config --version || echo "âŒ llvm-config failed"

        echo "ğŸ” llvm-config --libs:"
        llvm-config --libs || echo "âŒ cannot list LLVM libs"

        echo "ğŸ” llvm-config --cflags:"
        llvm-config --cflags || echo "âŒ cannot get LLVM cflags"

        echo "ğŸ” pkg-config opencv4:"
        pkg-config --modversion opencv4 || echo "âŒ pkg-config can't find opencv4"

        echo "âœ… Clang/LLVM debug check complete"
      shell: bash

    - name: ğŸ” Check llvm-config
      run: |
        echo "llvm-config: $(which llvm-config || echo MISSING)"
        llvm-config --version || echo "llvm-config call failed"
      shell: bash

    - name: ğŸ”§ Install Rust (Stable)
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      shell: bash

    - name: ğŸ’¾ Rust Cache
      uses: Swatinem/rust-cache@v2
